<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Authentication - Student Scheduler</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .test-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
        }

        .test-card:hover {
            transform: translateY(-5px);
        }

        .test-card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-card .icon {
            font-size: 1.8em;
        }

        .test-card p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .test-section {
            margin-bottom: 20px;
        }

        .test-section h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .test-button {
            width: 100%;
            padding: 15px 20px;
            margin: 8px 0;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: scale(1.02);
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
            transform: scale(1.02);
        }

        .btn-info {
            background: #4299e1;
            color: white;
        }

        .btn-info:hover {
            background: #3182ce;
            transform: scale(1.02);
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn-warning:hover {
            background: #dd6b20;
            transform: scale(1.02);
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
            transform: scale(1.02);
        }

        .test-result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-size: 0.9em;
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
        }

        .result-success {
            background: #c6f6d5;
            border: 2px solid #48bb78;
            color: #22543d;
        }

        .result-error {
            background: #fed7d7;
            border: 2px solid #f56565;
            color: #742a2a;
        }

        .result-info {
            background: #bee3f8;
            border: 2px solid #4299e1;
            color: #2c5282;
        }

        .info-box {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        .info-box h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .info-box ul {
            list-style: none;
            padding-left: 0;
        }

        .info-box li {
            padding: 8px 0;
            color: #555;
            display: flex;
            align-items: start;
            gap: 10px;
        }

        .info-box li:before {
            content: "‚úÖ";
            flex-shrink: 0;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-left: 10px;
        }

        .badge-demo {
            background: #ffd93d;
            color: #744210;
        }

        .badge-prod {
            background: #90cdf4;
            color: #2c5282;
        }

        code {
            background: #f7fafc;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #e53e3e;
        }

        .divider {
            height: 2px;
            background: linear-gradient(to right, transparent, #667eea, transparent);
            margin: 20px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üéì Student Scheduler - Test Authentication</h1>
            <p>C√¥ng c·ª• test ƒëƒÉng nh·∫≠p v√† ch·ª©c nƒÉng</p>
        </div>

        <!-- Current Mode Info -->
        <div class="info-box">
            <h3>üìã Tr·∫°ng th√°i hi·ªán t·∫°i</h3>
            <ul>
                <li>Frontend URL: <code>http://localhost:5173</code></li>
                <li>API URL: <code>http://localhost:7071/api</code></li>
                <li>Mode: <span id="currentMode" class="status-badge">ƒêang ki·ªÉm tra...</span></li>
                <li>Auto-login: <span id="autoLogin">ƒêang ki·ªÉm tra...</span></li>
            </ul>
            <div class="divider"></div>
            <p style="color: #666; margin-top: 15px;">
                <strong>L∆∞u √Ω:</strong> ƒê·∫£m b·∫£o c·∫£ Frontend (port 5173) v√† API (port 7071) ƒëang ch·∫°y tr∆∞·ªõc khi test!
            </p>
        </div>

        <!-- Test Cards Grid -->
        <div class="test-grid">
            <!-- Demo Mode Tests -->
            <div class="test-card">
                <h2><span class="icon">üé≠</span>Demo Mode</h2>
                <p>Test ch·∫ø ƒë·ªô demo v·ªõi user gi·∫£ l·∫≠p</p>

                <div class="test-section">
                    <h3>1. Ki·ªÉm tra c·∫•u h√¨nh</h3>
                    <button class="test-button btn-info" onclick="checkDemoConfig()">
                        üîç Ki·ªÉm tra .env.local
                    </button>
                </div>

                <div class="test-section">
                    <h3>2. Test auto-login</h3>
                    <button class="test-button btn-success" onclick="testAutoLogin()">
                        üöÄ Test Auto-Login
                    </button>
                </div>

                <div class="test-section">
                    <h3>3. Test th·ªß c√¥ng</h3>
                    <button class="test-button btn-primary" onclick="openDemoApp()">
                        üéØ M·ªü ·ª©ng d·ª•ng Demo
                    </button>
                </div>

                <div id="demoResult" class="test-result" style="display: none;"></div>
            </div>

            <!-- Microsoft Login Tests -->
            <div class="test-card">
                <h2><span class="icon">üîê</span>Microsoft Login</h2>
                <p>Test ƒëƒÉng nh·∫≠p v·ªõi Microsoft Entra ID</p>

                <div class="test-section">
                    <h3>1. Ki·ªÉm tra c·∫•u h√¨nh</h3>
                    <button class="test-button btn-info" onclick="checkMicrosoftConfig()">
                        üîç Ki·ªÉm tra Entra ID
                    </button>
                </div>

                <div class="test-section">
                    <h3>2. Test CORS</h3>
                    <button class="test-button btn-warning" onclick="testCORS()">
                        üåê Test CORS API
                    </button>
                </div>

                <div class="test-section">
                    <h3>3. Switch to Microsoft</h3>
                    <button class="test-button btn-primary" onclick="switchToMicrosoft()">
                        üîÑ Chuy·ªÉn sang Microsoft
                    </button>
                </div>

                <div id="microsoftResult" class="test-result" style="display: none;"></div>
            </div>

            <!-- API Tests -->
            <div class="test-card">
                <h2><span class="icon">‚öôÔ∏è</span>API Tests</h2>
                <p>Test c√°c endpoint API</p>

                <div class="test-section">
                    <h3>1. Health check</h3>
                    <button class="test-button btn-info" onclick="testAPIHealth()">
                        üíö Test API Health
                    </button>
                </div>

                <div class="test-section">
                    <h3>2. Test courses</h3>
                    <button class="test-button btn-success" onclick="testCoursesAPI()">
                        üìö Test /api/courses
                    </button>
                </div>

                <div class="test-section">
                    <h3>3. Test auth endpoints</h3>
                    <button class="test-button btn-warning" onclick="testAuthAPI()">
                        üîë Test /api/auth/*
                    </button>
                </div>

                <div id="apiResult" class="test-result" style="display: none;"></div>
            </div>

            <!-- Quick Actions -->
            <div class="test-card">
                <h2><span class="icon">‚ö°</span>Quick Actions</h2>
                <p>Thao t√°c nhanh v√† debug</p>

                <div class="test-section">
                    <h3>Clear & Reset</h3>
                    <button class="test-button btn-danger" onclick="clearStorage()">
                        üóëÔ∏è Clear LocalStorage
                    </button>
                    <button class="test-button btn-warning" onclick="resetToDemo()">
                        üîÑ Reset v·ªÅ Demo
                    </button>
                </div>

                <div class="test-section">
                    <h3>Debug Tools</h3>
                    <button class="test-button btn-info" onclick="showStorageData()">
                        üì¶ Xem LocalStorage
                    </button>
                    <button class="test-button btn-info" onclick="checkServers()">
                        üñ•Ô∏è Check Servers
                    </button>
                </div>

                <div id="quickResult" class="test-result" style="display: none;"></div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="info-box">
            <h3>üìñ H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h3>
            <ul>
                <li><strong>Demo Mode:</strong> Click "Ki·ªÉm tra .env.local" ‚Üí "Test Auto-Login" ‚Üí "M·ªü ·ª©ng d·ª•ng Demo"
                </li>
                <li><strong>Microsoft Login:</strong> Click "Chuy·ªÉn sang Microsoft" ‚Üí Reload app ‚Üí Test login</li>
                <li><strong>Debug:</strong> D√πng "Clear LocalStorage" n·∫øu g·∫∑p l·ªói ‚Üí "Reset v·ªÅ Demo" ƒë·ªÉ quay l·∫°i demo
                </li>
                <li><strong>API Tests:</strong> Ki·ªÉm tra t·ª´ng endpoint ƒë·ªÉ ƒë·∫£m b·∫£o backend ho·∫°t ƒë·ªông</li>
            </ul>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:7071/api';
        const APP_URL = 'http://localhost:5173';

        // Check current mode on load
        window.addEventListener('load', () => {
            checkCurrentMode();
        });

        async function checkCurrentMode() {
            try {
                const response = await fetch(`${APP_URL}/.env.local`);
                const text = await response.text();

                const isDemo = text.includes('VITE_ENTRA_CLIENT_ID=demo-mode');
                const modeEl = document.getElementById('currentMode');
                const autoLoginEl = document.getElementById('autoLogin');

                if (isDemo) {
                    modeEl.textContent = 'Demo Mode';
                    modeEl.className = 'status-badge badge-demo';
                    autoLoginEl.textContent = '‚úÖ Enabled (Auto-login khi load)';
                } else {
                    modeEl.textContent = 'Microsoft Mode';
                    modeEl.className = 'status-badge badge-prod';
                    autoLoginEl.textContent = '‚ùå Disabled (C·∫ßn click n√∫t login)';
                }
            } catch (error) {
                document.getElementById('currentMode').textContent = 'Kh√¥ng x√°c ƒë·ªãnh';
                document.getElementById('autoLogin').textContent = '‚ùì Kh√¥ng th·ªÉ ki·ªÉm tra';
            }
        }

        function showResult(elementId, message, type = 'info') {
            const el = document.getElementById(elementId);
            el.style.display = 'block';
            el.className = `test-result result-${type}`;
            el.innerHTML = message;
        }

        // Demo Mode Tests
        async function checkDemoConfig() {
            const instructions = `
                <strong>‚úÖ Ki·ªÉm tra c·∫•u h√¨nh Demo Mode:</strong><br><br>
                
                1. M·ªü file: <code>/frontend/.env.local</code><br>
                2. Ki·ªÉm tra c√°c d√≤ng sau:<br>
                <code>VITE_ENTRA_CLIENT_ID=demo-mode</code><br>
                <code>VITE_ENTRA_TENANT_ID=demo-mode</code><br><br>
                
                3. N·∫øu ƒë√∫ng ‚Üí Demo mode ƒëang active! ‚úÖ<br>
                4. N·∫øu sai ‚Üí Ch·∫°y "Reset v·ªÅ Demo" ·ªü Quick Actions<br><br>
                
                <strong>Auto-login s·∫Ω ho·∫°t ƒë·ªông khi:</strong><br>
                ‚úÖ .env.local c√≥ demo-mode<br>
                ‚úÖ LocalStorage tr·ªëng (ho·∫∑c ƒë√£ clear)<br>
                ‚úÖ Load trang l·∫ßn ƒë·∫ßu
            `;
            showResult('demoResult', instructions, 'info');
        }

        async function testAutoLogin() {
            showResult('demoResult', 'üîÑ ƒêang test auto-login...', 'info');

            setTimeout(() => {
                const result = `
                    <strong>‚úÖ Test Auto-Login:</strong><br><br>
                    
                    <strong>B∆∞·ªõc 1:</strong> Clear LocalStorage<br>
                    <button onclick="clearStorage()" style="padding: 5px 15px; margin: 10px 0; border: none; background: #f56565; color: white; border-radius: 5px; cursor: pointer;">Clear Now</button><br><br>
                    
                    <strong>B∆∞·ªõc 2:</strong> M·ªü app trong tab m·ªõi<br>
                    <button onclick="window.open('${APP_URL}', '_blank')" style="padding: 5px 15px; margin: 10px 0; border: none; background: #48bb78; color: white; border-radius: 5px; cursor: pointer;">Open App</button><br><br>
                    
                    <strong>K·∫øt qu·∫£ mong ƒë·ª£i:</strong><br>
                    ‚úÖ Loading spinner hi·ªán ra<br>
                    ‚úÖ T·ª± ƒë·ªông login v·ªõi "Sinh vi√™n Demo"<br>
                    ‚úÖ Chuy·ªÉn th·∫≥ng v√†o Dashboard<br>
                    ‚úÖ Header hi·ªÉn th·ªã t√™n user<br><br>
                    
                    <strong>Console log:</strong><br>
                    <code>üé≠ Demo mode detected - Auto-login as demo user</code>
                `;
                showResult('demoResult', result, 'success');
            }, 500);
        }

        function openDemoApp() {
            window.open(APP_URL, '_blank');
            showResult('demoResult', '‚úÖ ƒê√£ m·ªü app trong tab m·ªõi!<br><br>B·∫°n s·∫Ω th·∫•y auto-login n·∫øu .env.local ƒë√∫ng c·∫•u h√¨nh.', 'success');
        }

        // Microsoft Login Tests
        async function checkMicrosoftConfig() {
            const instructions = `
                <strong>üîê Ki·ªÉm tra c·∫•u h√¨nh Microsoft:</strong><br><br>
                
                1. M·ªü file: <code>/frontend/.env.local</code><br>
                2. B·ªè comment v√† c·∫≠p nh·∫≠t:<br>
                <code>VITE_ENTRA_CLIENT_ID=37ff0c04-1d21-4a5f-b5b4-303c13358afb</code><br>
                <code>VITE_ENTRA_TENANT_ID=5f802bcb-2987-4495-bc98-97f3d78164a3</code><br><br>
                
                3. Ki·ªÉm tra Azure Portal:<br>
                ‚úÖ App Registration c√≥ Client ID ƒë√∫ng<br>
                ‚úÖ Redirect URI: <code>http://localhost:5173</code><br>
                ‚úÖ CORS trong API cho ph√©p origin n√†y<br><br>
                
                4. Restart c·∫£ Frontend v√† API sau khi ƒë·ªïi
            `;
            showResult('microsoftResult', instructions, 'info');
        }

        async function testCORS() {
            showResult('microsoftResult', 'üîÑ Testing CORS...', 'info');

            try {
                const response = await fetch(`${API_URL}/courses`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult('microsoftResult', `‚úÖ CORS OK!<br><br>ƒê√£ l·∫•y ƒë∆∞·ª£c ${data.length || 0} courses t·ª´ API.<br><br>API c√≥ th·ªÉ giao ti·∫øp v·ªõi Frontend.`, 'success');
                } else {
                    showResult('microsoftResult', `‚ö†Ô∏è API response: ${response.status}<br><br>CORS c√≥ th·ªÉ c√≥ v·∫•n ƒë·ªÅ.`, 'error');
                }
            } catch (error) {
                showResult('microsoftResult', `‚ùå CORS Error:<br><br>${error.message}<br><br>Ki·ªÉm tra:<br>‚úÖ API ƒëang ch·∫°y?<br>‚úÖ host.json c√≥ CORS config?`, 'error');
            }
        }

        function switchToMicrosoft() {
            const instructions = `
                <strong>üîÑ Chuy·ªÉn sang Microsoft Mode:</strong><br><br>
                
                <strong>B∆∞·ªõc 1:</strong> Edit <code>.env.local</code>:<br>
                <pre style="background: #f7fafc; padding: 10px; border-radius: 5px; overflow-x: auto;">
# Comment demo mode
# VITE_ENTRA_CLIENT_ID=demo-mode
# VITE_ENTRA_TENANT_ID=demo-mode

# Uncomment Microsoft
VITE_ENTRA_CLIENT_ID=37ff0c04-1d21-4a5f-b5b4-303c13358afb
VITE_ENTRA_TENANT_ID=5f802bcb-2987-4495-bc98-97f3d78164a3</pre><br>
                
                <strong>B∆∞·ªõc 2:</strong> Restart Frontend:<br>
                <code>npm run dev</code> trong terminal<br><br>
                
                <strong>B∆∞·ªõc 3:</strong> Clear storage v√† reload app<br>
                <button onclick="clearStorage(); setTimeout(() => window.open('${APP_URL}', '_blank'), 500)" style="padding: 5px 15px; margin: 10px 0; border: none; background: #4299e1; color: white; border-radius: 5px; cursor: pointer;">Clear & Open</button>
            `;
            showResult('microsoftResult', instructions, 'info');
        }

        // API Tests
        async function testAPIHealth() {
            showResult('apiResult', 'üîÑ Checking API health...', 'info');

            try {
                const response = await fetch(`${API_URL}/courses`);

                if (response.ok) {
                    showResult('apiResult', `‚úÖ API is healthy!<br><br>Status: ${response.status}<br>API ƒëang ch·∫°y t·ªët tr√™n port 7071.`, 'success');
                } else {
                    showResult('apiResult', `‚ö†Ô∏è API returned: ${response.status}<br><br>C√≥ th·ªÉ c·∫ßn restart.`, 'error');
                }
            } catch (error) {
                showResult('apiResult', `‚ùå API kh√¥ng ph·∫£n h·ªìi!<br><br>${error.message}<br><br>Ki·ªÉm tra: <code>cd api && func start</code>`, 'error');
            }
        }

        async function testCoursesAPI() {
            showResult('apiResult', 'üîÑ Testing /api/courses...', 'info');

            try {
                const response = await fetch(`${API_URL}/courses`);
                const data = await response.json();

                if (response.ok && Array.isArray(data)) {
                    const sampleCourse = data[0];
                    showResult('apiResult', `
                        ‚úÖ Courses API OK!<br><br>
                        <strong>T·ªïng s·ªë m√¥n:</strong> ${data.length}<br>
                        <strong>Sample course:</strong><br>
                        <code>${JSON.stringify(sampleCourse, null, 2)}</code>
                    `, 'success');
                } else {
                    showResult('apiResult', `‚ö†Ô∏è Unexpected response format`, 'error');
                }
            } catch (error) {
                showResult('apiResult', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testAuthAPI() {
            showResult('apiResult', 'üîÑ Testing auth endpoints...', 'info');

            const endpoints = [
                '/auth/validate',
                '/auth/profile',
                '/auth/login'
            ];

            let results = '<strong>Auth Endpoints Test:</strong><br><br>';

            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`${API_URL}${endpoint}`);
                    const status = response.status;
                    const statusText = response.ok ? '‚úÖ' : '‚ö†Ô∏è';
                    results += `${statusText} ${endpoint}: ${status}<br>`;
                } catch (error) {
                    results += `‚ùå ${endpoint}: ${error.message}<br>`;
                }
            }

            results += '<br><strong>Note:</strong> 401/403 l√† b√¨nh th∆∞·ªùng (ch∆∞a login)';
            showResult('apiResult', results, 'info');
        }

        // Quick Actions
        function clearStorage() {
            localStorage.clear();
            sessionStorage.clear();
            showResult('quickResult', '‚úÖ ƒê√£ x√≥a to√†n b·ªô LocalStorage & SessionStorage!<br><br>Reload app ƒë·ªÉ test l·∫°i t·ª´ ƒë·∫ßu.', 'success');
        }

        function resetToDemo() {
            const instructions = `
                <strong>üîÑ Reset v·ªÅ Demo Mode:</strong><br><br>
                
                1. Edit <code>.env.local</code> v·ªõi n·ªôi dung:<br>
                <pre style="background: #f7fafc; padding: 10px; border-radius: 5px; overflow-x: auto;">
VITE_API_URL=http://localhost:7071/api
VITE_REDIRECT_URI=http://localhost:5173

# Demo Mode (ACTIVE)
VITE_ENTRA_CLIENT_ID=demo-mode
VITE_ENTRA_TENANT_ID=demo-mode

# Microsoft Login (COMMENTED)
# VITE_ENTRA_CLIENT_ID=37ff0c04-1d21-4a5f-b5b4-303c13358afb
# VITE_ENTRA_TENANT_ID=5f802bcb-2987-4495-bc98-97f3d78164a3</pre><br>
                
                2. Click n√†y:<br>
                <button onclick="clearStorage(); alert('Storage cleared! B√¢y gi·ªù restart frontend v·ªõi npm run dev')" style="padding: 8px 15px; margin: 10px 0; border: none; background: #f56565; color: white; border-radius: 5px; cursor: pointer; font-weight: 600;">Clear Storage</button><br><br>
                
                3. Restart frontend: <code>npm run dev</code><br>
                4. Reload app v√† test!
            `;
            showResult('quickResult', instructions, 'info');
        }

        function showStorageData() {
            const storage = { ...localStorage };
            const keys = Object.keys(storage);

            if (keys.length === 0) {
                showResult('quickResult', 'üì¶ LocalStorage tr·ªëng!<br><br>Kh√¥ng c√≥ d·ªØ li·ªáu login.', 'info');
            } else {
                let result = '<strong>üì¶ LocalStorage Data:</strong><br><br>';
                keys.forEach(key => {
                    const value = storage[key];
                    const displayValue = value.length > 50 ? value.substring(0, 50) + '...' : value;
                    result += `<strong>${key}:</strong><br><code>${displayValue}</code><br><br>`;
                });
                showResult('quickResult', result, 'info');
            }
        }

        async function checkServers() {
            showResult('quickResult', 'üîÑ Checking servers...', 'info');

            let result = '<strong>üñ•Ô∏è Server Status:</strong><br><br>';

            // Check Frontend
            try {
                const frontendRes = await fetch(APP_URL);
                result += `‚úÖ Frontend (5173): ${frontendRes.ok ? 'Running' : 'Error'}<br>`;
            } catch (e) {
                result += `‚ùå Frontend (5173): Not running<br>`;
            }

            // Check API
            try {
                const apiRes = await fetch(`${API_URL}/courses`);
                result += `‚úÖ API (7071): ${apiRes.ok ? 'Running' : 'Error'}<br>`;
            } catch (e) {
                result += `‚ùå API (7071): Not running<br>`;
            }

            result += '<br><strong>C·∫ßn ch·∫°y:</strong><br>';
            result += '‚Ä¢ Frontend: <code>cd frontend && npm run dev</code><br>';
            result += '‚Ä¢ API: <code>cd api && func start</code>';

            showResult('quickResult', result, 'info');
        }
    </script>
</body>

</html>